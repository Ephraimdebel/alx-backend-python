#!/bin/bash

echo "ğŸš€ Starting rolling update for messaging-app-blue..."

# Apply the updated deployment
kubectl apply -f blue_deployment.yaml

# Monitor rollout progress
echo "ğŸ”„ Monitoring rollout status..."
kubectl rollout status deployment/messaging-app-blue

# Test for downtime
echo "âš¡ Testing application availability during rollout..."
for i in {1..15}; do
  curl -s http://localhost:8000/ > /dev/null && \
  echo "âœ… App responding (request #$i)" || \
  echo "âŒ App not responding (request #$i)"
  sleep 2
done

# Check the new pods after rollout
echo "ğŸ“¦ Current running pods:"
kubectl get pods -l app=messaging-app,version=blue -o wide

echo "âœ… Rolling update complete!"
